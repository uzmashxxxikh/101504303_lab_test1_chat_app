<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Chat</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            transition: background 0.3s ease;
        }

        body.dark-mode {
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
        }

        .chat-wrapper {
            max-width: 1200px;
            width: 100%;
            height: 85vh;
            min-height: 600px;
            max-height: 800px;
        }

        .chat-card {
            height: 100%;
            border-radius: 18px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .card-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }

        .room-controls {
            flex-shrink: 0;
        }

        .dark-mode .chat-card {
            background: #2d3748;
        }

        .chat-header {
            background: #4c51bf;
            color: #fff;
            flex-shrink: 0;
        }

        .dark-mode .chat-header {
            background: #1a202c;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            background: #f8fafc;
            padding: 1rem;
            min-height: 0;
        }

        #typing {
            flex-shrink: 0;
        }

        .dark-mode .chat-messages {
            background: #1a202c;
        }

        .message {
            margin-bottom: 0.5rem;
        }

        .message.me {
            text-align: right;
        }

        .message.me .bubble {
            background: #4c51bf;
            color: #fff;
        }

        .dark-mode .message.me .bubble {
            background: #5a67d8;
        }

        .bubble {
            display: inline-block;
            padding: .4rem .75rem;
            border-radius: 12px;
            background: #e2e8f0;
            color: #1a202c;
        }

        .dark-mode .bubble {
            background: #4a5568;
            color: #e2e8f0;
        }

        .bubble small {
            color: #4a5568 !important;
            font-weight: 500;
        }

        .message.me .bubble small {
            color: rgba(255, 255, 255, 0.95) !important;
        }

        .dark-mode .bubble small {
            color: #cbd5e0 !important;
        }

        .dark-mode .message.me .bubble small {
            color: rgba(255, 255, 255, 0.95) !important;
        }

        .chat-footer {
            background: #fff;
            border-top: 1px solid #e2e8f0;
            flex-shrink: 0;
        }

        .dark-mode .chat-footer {
            background: #2d3748;
            border-top: 1px solid #4a5568;
        }

        .dark-mode .form-control,
        .dark-mode .form-select {
            background: #4a5568;
            color: #e2e8f0;
            border-color: #718096;
        }

        .dark-mode .form-control::placeholder {
            color: #a0aec0;
        }

        .dark-mode .text-muted {
            color: #a0aec0 !important;
        }

        .dark-mode .border-bottom {
            border-color: #4a5568 !important;
        }

        .theme-toggle {
            cursor: pointer;
            font-size: 1.2rem;
            margin-left: 0.5rem;
        }

        @media (max-width: 1024px) {
            .chat-wrapper {
                max-width: 95%;
                height: 80vh;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 0.5rem;
            }

            .chat-wrapper {
                height: 90vh;
                max-height: none;
                min-height: 500px;
            }

            .chat-card {
                border-radius: 12px;
            }

            .chat-header {
                padding: 0.75rem !important;
            }

            .chat-header .fw-semibold {
                font-size: 0.9rem;
            }

            .chat-header small {
                font-size: 0.7rem;
            }

            .btn-sm {
                font-size: 0.75rem;
                padding: 0.25rem 0.5rem;
            }

            .chat-messages {
                padding: 0.5rem;
            }

            .bubble {
                max-width: 85%;
                word-wrap: break-word;
            }

            .chat-footer {
                padding: 0.75rem !important;
            }
        }

        @media (max-width: 576px) {
            .chat-wrapper {
                height: 95vh;
            }

            .chat-header .d-flex {
                flex-wrap: wrap;
            }

            .form-select {
                font-size: 0.85rem;
            }

            #currentRoom {
                display: block;
                margin-top: 0.25rem;
            }

            .room-controls {
                padding: 0.5rem !important;
            }

            .room-controls .gap-2 {
                gap: 0.25rem !important;
            }
        }
    </style>
</head>

<body>
    <div class="chat-wrapper">
        <div class="card chat-card">
            <div class="card-header chat-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <div class="brand-icon me-2 bg-white bg-opacity-10 rounded-circle p-2">
                        <i class="bi bi-chat-dots"></i>
                    </div>
                    <div>
                        <div class="fw-semibold">COMP3133 Chat</div>
                        <small id="currentUser" class="opacity-75"></small>
                    </div>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <span class="theme-toggle" id="themeToggle" title="Toggle dark mode">
                        <i class="bi bi-moon-fill"></i>
                    </span>
                    <button id="logoutBtn" class="btn btn-sm btn-outline-light">
                        <i class="bi bi-box-arrow-right me-1"></i>Logout
                    </button>
                </div>
            </div>

            <div class="card-body p-0">
                <div class="p-3 border-bottom d-flex align-items-center gap-2 room-controls">
                    <label class="form-label mb-0 me-2">Room</label>
                    <select id="roomSelect" class="form-select form-select-sm w-auto"></select>
                    <button id="joinBtn" class="btn btn-success btn-sm">
                        <i class="bi bi-door-open me-1"></i>Join
                    </button>
                    <button id="leaveBtn" class="btn btn-secondary btn-sm">
                        <i class="bi bi-door-closed me-1"></i>Leave
                    </button>
                    <span class="ms-auto small text-muted">
                        Current room: <span id="currentRoom" class="fw-semibold">None</span>
                    </span>
                </div>

                <div id="chatBox" class="chat-messages"></div>
                <div id="typing" class="px-3 pt-1 pb-1 small text-muted" style="min-height:20px;"></div>

                <div class="chat-footer p-3">

                    <div class="px-3 pt-1 pb-0 small">
                        <label class="form-label mb-1">Private message</label>
                        <div class="input-group input-group-sm mb-2">
                            <input id="pmTo" type="text" class="form-control" placeholder="To username">
                            <input id="pmMessage" type="text" class="form-control" placeholder="Private message">
                            <button id="pmSendBtn" class="btn btn-outline-secondary">
                                <i class="bi bi-send"></i> PM
                            </button>
                        </div>
                    </div>

                    <div class="input-group">
                        <input id="messageInput" type="text" class="form-control" placeholder="Type your message..."
                            disabled>
                        <button id="sendBtn" class="btn btn-primary" disabled>
                            <i class="bi bi-send"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const user = localStorage.getItem('chatUser');
        if (!user) {
            window.location.href = '/views/login.html';
        }
        $('#currentUser').text('Logged in as ' + user);

        // Dark mode toggle
        const darkMode = localStorage.getItem('darkMode') === 'true';
        if (darkMode) {
            $('body').addClass('dark-mode');
            $('#themeToggle i').removeClass('bi-moon-fill').addClass('bi-sun-fill');
        }

        $('#themeToggle').on('click', () => {
            $('body').toggleClass('dark-mode');
            const isDark = $('body').hasClass('dark-mode');
            localStorage.setItem('darkMode', isDark);
            if (isDark) {
                $('#themeToggle i').removeClass('bi-moon-fill').addClass('bi-sun-fill');
            } else {
                $('#themeToggle i').removeClass('bi-sun-fill').addClass('bi-moon-fill');
            }
        });

        const socket = io();
        socket.emit('setUsername', user);
        
        let currentRoom = null;
        let typingTimeout = null;

        async function loadRooms() {
            const res = await fetch('/api/rooms');
            const rooms = await res.json();
            $('#roomSelect').empty();
            rooms.forEach(r => {
                $('#roomSelect').append(`<option value="${r}">${r}</option>`);
            });
        }
        loadRooms();

        function addMessage({ text, from, me, time }) {
            const cls = me ? 'message me' : 'message';
            const safeFrom = from ? `<strong>${from}</strong> Â· ` : '';
            $('#chatBox').append(
                `<div class="${cls}">
           <div class="bubble">
             <small>${safeFrom}${time || ''}</small><br>
             ${text}
           </div>
         </div>`
            );
            $('#chatBox').scrollTop($('#chatBox')[0].scrollHeight);
        }

        function clearMessages() {
            $('#chatBox').empty();
        }
        // SEND PRIVATE MESSAGE
        $('#pmSendBtn').on('click', () => {
            const to = $('#pmTo').val().trim();
            const msg = $('#pmMessage').val().trim();
            if (!to || !msg) {
                alert('Please enter both recipient username and message');
                return;
            }
            socket.emit('privateMessage', { to_user: to, message: msg });
            $('#pmMessage').val('');
        });

        // Allow Enter key to send PM
        $('#pmMessage').on('keypress', (e) => {
            if (e.which === 13) {
                $('#pmSendBtn').click();
            }
        });

        // SHOW PRIVATE MESSAGE IN CHAT
        socket.on('privateMessage', (data) => {
            const isFromMe = data.from_user === user;
            const otherUser = isFromMe ? data.to_user : data.from_user;
            const direction = isFromMe ? 'to' : 'from';
            
            addMessage({
                text: `[PM ${direction} ${otherUser}] ${data.message}`,
                from: data.from_user,
                me: isFromMe,
                time: data.date_sent
            });
        });



        $('#joinBtn').on('click', async () => {
            const room = $('#roomSelect').val();
            if (!room) return;

            if (currentRoom) {
                socket.emit('leaveRoom');
            }

            clearMessages();

            socket.emit('joinRoom', { username: user, room });
            currentRoom = room;
            $('#currentRoom').text(room);
            $('#messageInput').prop('disabled', false);
            $('#sendBtn').prop('disabled', false);

            addMessage({ text: 'Joined room: ' + room, from: '', me: true, time: '' });

            try {
                const res = await fetch('/api/messages/' + encodeURIComponent(room));
                const msgs = await res.json();
                msgs.forEach(m => {
                    addMessage({
                        text: m.message,
                        from: m.from_user,
                        me: m.from_user === user,
                        time: m.date_sent
                    });
                });
            } catch (e) {
                console.error(e);
            }
        });



        $('#leaveBtn').on('click', () => {
            if (!currentRoom) return;
            socket.emit('leaveRoom');
            addMessage({ text: 'Left room: ' + currentRoom, from: '', me: true, time: '' });
            currentRoom = null;
            $('#currentRoom').text('None');
            $('#messageInput').prop('disabled', true);
            $('#sendBtn').prop('disabled', true);
        });

        $('#sendBtn').on('click', () => {
            const msg = $('#messageInput').val().trim();
            if (!msg || !currentRoom) return;
            socket.emit('chatMessage', { room: currentRoom, message: msg, username: user });
            $('#messageInput').val('');
        });

        $('#messageInput').on('input', () => {
            if (!currentRoom) return;
            socket.emit('typing', { room: currentRoom, isTyping: true });
            if (typingTimeout) clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                socket.emit('typing', { room: currentRoom, isTyping: false });
            }, 1000);
        });

        socket.on('chatMessage', (data) => {
            addMessage({
                text: data.message,
                from: data.from_user,
                me: data.from_user === user,
                time: data.date_sent
            });
        });

        socket.on('systemMessage', (text) => {
            addMessage({ text: '[SYSTEM] ' + text, from: '', me: false, time: '' });
        });

        socket.on('typing', (data) => {
            if (data.isTyping) {
                $('#typing').text(data.username + ' is typing...');
            } else {
                $('#typing').text('');
            }
        });

        $('#logoutBtn').on('click', () => {
            localStorage.removeItem('chatUser');
            window.location.href = '/views/login.html';
        });
    </script>
</body>

</html>